# server_api/exploit_framework/searchsploit.py

from flask import Blueprint, request, jsonify
from server_core.command_executor import execute_command
import logging

logger = logging.getLogger(__name__)

api_exploit_framework_searchsploit_bp = Blueprint("api_exploit_framework_searchsploit", __name__)

@api_exploit_framework_searchsploit_bp.route("/api/tools/exploit_framework/searchsploit", methods=["POST"])
def searchsploit():
    """
    Execute SearchSploit for local exploit database searching.

    Endpoint: POST /api/tools/exploit_framework/searchsploit

    Description:
        This endpoint executes SearchSploit for local exploit database searching based on a provided query.
        It accepts a search query and optional additional arguments for SearchSploit, runs the tool,
        and returns the results.
    Request (application/json):
        {
            "query": "<string, required> The search query for SearchSploit (e.g., 'apache 2.4.49').",
            "additional_args": "<string, optional> Extra CLI flags for SearchSploit (e.g., '-w', '-j')."
        }
    Response (application/json):
        {
            "success": "<boolean> Indicates if the search was successful.",
            "data": "<object> The results from the SearchSploit search."
        }
    """
    data = request.get_json()
    query = data.get("query")
    additional_args = data.get("additional_args", "")

    if not query:
        return jsonify({"success": False, "error": "Query is required"}), 400

    command = f"searchsploit {query} {additional_args} -j"
    logger.info(f"üîç Starting SearchSploit: {query}")
    result = execute_command(command, use_cache=True)
    if result.get("success"):
        logger.info(f"‚úÖ SearchSploit completed for {query}")
    else:
        logger.error(f"‚ùå SearchSploit failed for {query}")
    return jsonify(result)